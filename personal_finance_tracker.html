<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .csv-drop-zone, .pdf-drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .csv-drop-zone.dragover, .pdf-drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .baseline-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .lisa-income-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .investment-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Authentication Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Personal Finance Tracker</h1>
            <div id="authForm">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded-lg mb-4">
                <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded-lg mb-4">
                <button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg mb-2 hover:bg-blue-700">Sign In</button>
                <button id="registerBtn" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700">Register</button>
            </div>
            <div id="authError" class="text-red-500 text-sm mt-4 hidden"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-900">Finance Tracker</h1>
                    <div class="flex items-center space-x-4">
                        <span id="userEmail" class="text-gray-600"></span>
                        <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Export</button>
                        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-blue-600 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button class="nav-btn text-white px-3 py-4 font-medium border-b-2 border-blue-600" data-tab="dashboard">Dashboard</button>
                    <button class="nav-btn text-blue-200 px-3 py-4 font-medium hover:text-white" data-tab="accounts">Accounts</button>
                    <button class="nav-btn text-blue-200 px-3 py-4 font-medium hover:text-white" data-tab="transactions">Transactions</button>
                    <button class="nav-btn text-blue-200 px-3 py-4 font-medium hover:text-white" data-tab="import">Import Data</button>
                    <button class="nav-btn text-blue-200 px-3 py-4 font-medium hover:text-white" data-tab="investments">Investments</button>
                    <button class="nav-btn text-blue-200 px-3 py-4 font-medium hover:text-white" data-tab="analytics">Analytics</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <!-- Primary Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Total Income (This Month)</h3>
                        <p id="totalIncome" class="text-2xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Total Expenses (This Month)</h3>
                        <p id="totalExpenses" class="text-2xl font-bold text-red-600">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Net Savings (This Month)</h3>
                        <p id="netSavings" class="text-2xl font-bold text-blue-600">$0.00</p>
                    </div>
                    <div class="baseline-card text-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium opacity-90">Total Net Worth</h3>
                        <p id="totalNetWorth" class="text-2xl font-bold">$0.00</p>
                        <div class="text-xs opacity-75 mt-1">
                            Baseline: <span id="baselineDisplay">$0</span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Business Performance -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium opacity-90">Real Estate Net</h3>
                        <p id="realEstateNet" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium opacity-90">Business Net</h3>
                        <p id="businessNet" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div class="lisa-income-card text-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium opacity-90">Lisa's Monthly Income</h3>
                        <p id="lisaIncome" class="text-2xl font-bold">$0.00</p>
                        <div class="text-xs opacity-75 mt-1">From rent distributions</div>
                    </div>
                    <div class="investment-card text-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium opacity-90">Investment Contributions</h3>
                        <p id="totalInvestmentContributions" class="text-2xl font-bold">$0.00</p>
                        <div class="text-xs opacity-75 mt-1">
                            Business: <span id="businessContributions">$0</span> | Direct: <span id="directContributions">$0</span>
                        </div>
                    </div>
                </div>

                <!-- Monthly Goal Progress -->
                <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-lg font-semibold opacity-90">Monthly Goal Progress</h3>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-2xl font-bold">$17,932 Target</span>
                        <span id="combinedNet" class="text-2xl font-bold">$0.00</span>
                    </div>
                    <div class="w-full bg-orange-500 rounded-full h-3 mt-3">
                        <div id="goalProgress" class="bg-white h-3 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="text-sm opacity-75 mt-2">
                        <span id="goalPercentage">0%</span> of monthly goal achieved
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Recent Transactions</h2>
                    </div>
                    <div id="recentTransactions" class="p-6">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accounts" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Accounts</h2>
                    <div class="flex space-x-2">
                        <button id="setBaselineBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Set Baseline Net Worth</button>
                        <button id="refreshDataBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Refresh</button>
                        <button id="addAccountBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Account</button>
                        <button id="quickSetupBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Quick Setup</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsList" class="bg-white divide-y divide-gray-200">
                            <!-- Accounts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Investments Tab -->
            <div id="investments" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Investment Tracking</h2>
                    <div class="flex space-x-2">
                        <button id="uploadSchwabBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Upload Schwab Statement</button>
                        <button id="refreshInvestmentsBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Refresh</button>
                    </div>
                </div>

                <!-- Investment Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Current Investment Value</h3>
                        <p id="currentInvestmentValue" class="text-2xl font-bold text-blue-600">$0.00</p>
                        <div class="text-xs text-gray-500 mt-1">Last updated: <span id="lastUpdateDate">Never</span></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">This Month's Contributions</h3>
                        <p id="monthlyContributions" class="text-2xl font-bold text-green-600">$0.00</p>
                        <div class="text-xs text-gray-500 mt-1">Business + Direct deposits</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">YTD Contributions</h3>
                        <p id="ytdContributions" class="text-2xl font-bold text-purple-600">$0.00</p>
                        <div class="text-xs text-gray-500 mt-1">Total invested this year</div>
                    </div>
                </div>

                <!-- PDF Upload Area -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Upload Schwab PDF Statement</h3>
                    <div id="pdfDropZone" class="pdf-drop-zone border-2 rounded-lg p-8 text-center">
                        <p class="text-lg text-gray-600 mb-2">Drop Schwab PDF statement here or click to upload</p>
                        <input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
                        <button id="pdfUploadBtn" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Select PDF File</button>
                    </div>
                    <div id="pdfProcessingStatus" class="mt-4 hidden">
                        <div class="text-sm text-gray-600">Processing PDF...</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="pdfProgress" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Investment History -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Investment History</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Value/Contribution</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                                </tr>
                            </thead>
                            <tbody id="investmentHistoryTable" class="bg-white divide-y divide-gray-200">
                                <!-- Investment history will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Import Data Tab -->
            <div id="import" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Import CSV Data</h2>
                    <div class="flex space-x-2">
                        <button id="clearImportBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Clear</button>
                        <button id="validateImportBtn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700" disabled>Validate</button>
                        <button id="processImportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>Import</button>
                    </div>
                </div>

                <!-- CSV Upload Area -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Upload Chase CSV Files</h3>
                    <div id="csvDropZone" class="csv-drop-zone border-2 rounded-lg p-8 text-center">
                        <p class="text-lg text-gray-600 mb-2">Drop Chase CSV files here or click to upload</p>
                        <input type="file" id="csvFileInput" multiple accept=".csv" class="hidden">
                        <button id="csvUploadBtn" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Select Files</button>
                    </div>
                </div>

                <!-- Import Progress -->
                <div id="importProgress" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Import Progress</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between text-sm">
                            <span>Processing files...</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="progressLog" class="text-sm text-gray-600 max-h-32 overflow-y-auto">
                            <!-- Progress messages will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Import Preview -->
                <div id="importPreview" class="bg-white rounded-lg shadow-md p-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Import Preview</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Preview rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Transactions</h2>
                    <button id="addTransactionBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Transaction</button>
                </div>
                
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex space-x-4">
                            <select id="filterAccount" class="border rounded-lg px-3 py-2">
                                <option value="">All Accounts</option>
                            </select>
                            <select id="filterType" class="border rounded-lg px-3 py-2">
                                <option value="">All Types</option>
                                <option value="Income">Income</option>
                                <option value="Expense">Expense</option>
                                <option value="Transfer">Transfer</option>
                            </select>
                            <select id="filterCategory" class="border rounded-lg px-3 py-2">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                    <div id="transactionsList" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Account Analysis</h2>
                    <div class="flex space-x-2">
                        <select id="analyticsAccount" class="border rounded-lg px-3 py-2">
                            <option value="">All Accounts</option>
                        </select>
                        <button id="refreshAnalyticsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Analyze</button>
                    </div>
                </div>

                <div id="accountAnalysis" class="space-y-6">
                    <p class="text-gray-500 text-center">Click "Analyze" to see transaction patterns</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Baseline Net Worth Modal -->
    <div id="baselineModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Set Baseline Net Worth</h3>
            </div>
            <div class="px-6 py-4">
                <form id="baselineForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Baseline Net Worth Amount</label>
                        <input type="number" id="baselineAmount" step="0.01" class="w-full border rounded-lg px-3 py-2" placeholder="Enter baseline amount" required>
                        <div class="text-sm text-gray-500 mt-1">This includes assets not tracked in accounts (real estate, other investments, etc.)</div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <input type="text" id="baselineDescription" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Real estate + external investments">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelBaseline" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Set Baseline</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="accountModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Add New Account</h3>
            </div>
            <div class="px-6 py-4">
                <form id="accountForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Name</label>
                        <input type="text" id="accountName" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
                        <select id="accountType" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Type</option>
                            <option value="Checking">Checking</option>
                            <option value="Savings">Savings</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Investment">Investment</option>
                            <option value="Business">Business</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Starting Balance</label>
                        <input type="number" id="startingBalance" step="0.01" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelAccount" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transactionModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Add New Transaction</h3>
            </div>
            <div class="px-6 py-4">
                <form id="transactionForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input type="text" id="transactionDescription" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <input type="number" id="transactionAmount" step="0.01" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <select id="transactionType" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Type</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                            <option value="Transfer">Transfer</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="transactionDate" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                        <select id="transactionAccount" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Account</option>
                        </select>
                    </div>
                    <div id="transferAccountDiv" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Transfer to Account</label>
                        <select id="transferAccount" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select Account</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="transactionCategory" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Category</option>
                            <option value="Real Estate Income">Real Estate Income</option>
                            <option value="Business Income">Business Income</option>
                            <option value="Investment Income">Investment Income</option>
                            <option value="Property Expenses">Property Expenses</option>
                            <option value="Business Expenses">Business Expenses</option>
                            <option value="Personal Expenses">Personal Expenses</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Lisa's Income">Lisa's Income</option>
                            <option value="Investment Contribution">Investment Contribution</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelTransaction" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Transaction</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const DEMO_MODE = true; // Set to false for production Firebase
        
        let firebaseConfig, auth, db;
        
        if (!DEMO_MODE) {
            firebaseConfig = {
                apiKey: "AIzaSyBhXvFPf2yRXvT2GJA6A8Isgt2-GBSyv6g",
                authDomain: "personalfinancewebapp.firebaseapp.com",
                projectId: "personalfinancewebapp",
                storageBucket: "personalfinancewebapp.firebasestorage.app",
                messagingSenderId: "644377142720",
                appId: "1:644377142720:web:8a62f4a6f3f8b65285d425",
                measurementId: "G-9LGZ8SV0D9"
            };
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } else {
            // Demo mode with localStorage
            auth = {
                onAuthStateChanged: (callback) => {
                    setTimeout(() => callback({ uid: 'demo-user', email: 'demo@example.com' }), 100);
                },
                signInWithEmailAndPassword: () => Promise.resolve({ uid: 'demo-user', email: 'demo@example.com' }),
                createUserWithEmailAndPassword: () => Promise.resolve({ uid: 'demo-user', email: 'demo@example.com' }),
                signOut: () => {
                    localStorage.clear();
                    location.reload();
                }
            };
        }

        // Global variables
        let currentUser = null;
        let accounts = [];
        let transactions = [];
        let importedTransactions = [];
        let baselineNetWorth = 0;
        let investmentData = [];

        // Account number mapping for enhanced logic
        const ACCOUNT_MAPPING = {
            '0111': { name: 'Sweep Account (0111)', type: 'Checking' },
            '8529': { name: 'Real Estate Ops (8529)', type: 'Business' },
            '7991': { name: 'Tech Auditing (7991)', type: 'Business' },
            '2299': { name: 'Business Expenses (2299)', type: 'Credit Card' },
            '2434': { name: 'Visa Prime (2434)', type: 'Credit Card' },
            '7588': { name: 'Shared Checking (7588)', type: 'Checking' },
            '8895': { name: 'Investment (8895)', type: 'Investment' },
            '0898': { name: "Lisa's Income (0898)", type: 'Checking' }
        };

        // Enhanced categorization logic
        function enhancedCategorizeTransaction(description, fromAccount, toAccount, amount) {
            const desc = description.toLowerCase();
            
            // Check for specific transfer patterns
            if (fromAccount && toAccount) {
                // Tech Auditing to Investment
                if (fromAccount.includes('7991') && toAccount.includes('8895')) {
                    return 'Investment Contribution';
                }
                // Sweep to Lisa's account
                if (fromAccount.includes('0111') && toAccount.includes('0898')) {
                    return "Lisa's Income";
                }
            }
            
            // Regular categorization
            if (desc.includes('rent') || desc.includes('tenant')) return 'Real Estate Income';
            if (desc.includes('consulting') || desc.includes('invoice') || desc.includes('audit')) return 'Business Income';
            if (desc.includes('vyve') || desc.includes('frontier') || desc.includes('netflix')) return 'Utilities';
            if (desc.includes('insurance')) return 'Insurance';
            if (desc.includes('hsa') || desc.includes('health')) return 'Healthcare';
            if (desc.includes('amazon') || desc.includes('target') || desc.includes('grocery')) return 'Personal Expenses';
            if (desc.includes('property tax') || desc.includes('hoa')) return 'Property Expenses';
            if (desc.includes('transfer')) return 'Transfer';
            
            return 'Other';
        }

        // Authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadData();
            } else {
                currentUser = null;
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // Load data from storage
        async function loadData() {
            try {
                if (DEMO_MODE) {
                    const storedAccounts = localStorage.getItem('demo-accounts');
                    const storedTransactions = localStorage.getItem('demo-transactions');
                    const storedBaseline = localStorage.getItem('demo-baseline');
                    const storedInvestments = localStorage.getItem('demo-investments');
                    
                    accounts = storedAccounts ? JSON.parse(storedAccounts) : [];
                    transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                    baselineNetWorth = storedBaseline ? parseFloat(storedBaseline) : 0;
                    investmentData = storedInvestments ? JSON.parse(storedInvestments) : [];
                    
                    transactions = transactions.map(t => ({
                        ...t,
                        date: { seconds: new Date(t.date).getTime() / 1000 }
                    }));
                    
                    investmentData = investmentData.map(inv => ({
                        ...inv,
                        date: { seconds: new Date(inv.date).getTime() / 1000 }
                    }));
                } else {
                    // Firebase loading logic would go here
                }

                updateUI();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Save data to storage
        function saveData() {
            if (DEMO_MODE) {
                localStorage.setItem('demo-accounts', JSON.stringify(accounts));
                localStorage.setItem('demo-transactions', JSON.stringify(transactions.map(t => ({
                    ...t,
                    date: new Date(t.date.seconds * 1000).toISOString()
                }))));
                localStorage.setItem('demo-baseline', baselineNetWorth.toString());
                localStorage.setItem('demo-investments', JSON.stringify(investmentData.map(inv => ({
                    ...inv,
                    date: new Date(inv.date.seconds * 1000).toISOString()
                }))));
            }
        }

        // Enhanced dashboard calculations
        function calculateEnhancedMetrics() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthlyIncome = 0;
            let monthlyExpenses = 0;
            let realEstateIncome = 0;
            let businessIncome = 0;
            let realEstateExpenses = 0;
            let businessExpenses = 0;
            let lisaIncome = 0;
            let businessInvestmentContributions = 0;

            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date.seconds * 1000);
                if (transactionDate.getMonth() === currentMonth && 
                    transactionDate.getFullYear() === currentYear) {
                    
                    // Exclude investment contributions from expenses
                    if (transaction.category === 'Investment Contribution') {
                        businessInvestmentContributions += Math.abs(transaction.amount);
                        return; // Don't count as expense
                    }

                    // Handle Lisa's Income separately
                    if (transaction.category === "Lisa's Income") {
                        lisaIncome += Math.abs(transaction.amount);
                        return; // Don't count in main income/expense
                    }

                    if (transaction.type === 'Income' && transaction.category !== 'Transfer') {
                        monthlyIncome += transaction.amount;
                        if (transaction.category === 'Real Estate Income') {
                            realEstateIncome += transaction.amount;
                        } else if (transaction.category === 'Business Income') {
                            businessIncome += transaction.amount;
                        }
                    } else if (transaction.type === 'Expense' && transaction.category !== 'Transfer') {
                        monthlyExpenses += Math.abs(transaction.amount);
                        if (transaction.category === 'Property Expenses') {
                            realEstateExpenses += Math.abs(transaction.amount);
                        } else if (transaction.category === 'Business Expenses') {
                            businessExpenses += Math.abs(transaction.amount);
                        }
                    }
                }
            });

            // Get direct investment contributions from investment data
            const directContributions = investmentData
                .filter(inv => {
                    const invDate = new Date(inv.date.seconds * 1000);
                    return inv.type === 'contribution' && 
                           invDate.getMonth() === currentMonth && 
                           invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + inv.amount, 0);

            return {
                monthlyIncome,
                monthlyExpenses,
                realEstateIncome,
                businessIncome,
                realEstateExpenses,
                businessExpenses,
                lisaIncome,
                businessInvestmentContributions,
                directContributions,
                realEstateNet: realEstateIncome - realEstateExpenses,
                businessNet: businessIncome - businessExpenses,
                netSavings: monthlyIncome - monthlyExpenses
            };
        }

        function updateDashboard() {
            const metrics = calculateEnhancedMetrics();
            
            // Calculate total net worth including baseline and current investment value
            const accountsNetWorth = accounts.reduce((total, account) => total + account.balance, 0);
            const currentInvestmentValue = getCurrentInvestmentValue();
            const totalNetWorth = baselineNetWorth + accountsNetWorth + currentInvestmentValue;

            // Update main cards
            document.getElementById('totalIncome').textContent = formatCurrency(metrics.monthlyIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(metrics.monthlyExpenses);
            document.getElementById('netSavings').textContent = formatCurrency(metrics.netSavings);
            document.getElementById('totalNetWorth').textContent = formatCurrency(totalNetWorth);
            document.getElementById('baselineDisplay').textContent = formatCurrency(baselineNetWorth);

            // Update business performance cards
            document.getElementById('realEstateNet').textContent = formatCurrency(metrics.realEstateNet);
            document.getElementById('businessNet').textContent = formatCurrency(metrics.businessNet);
            document.getElementById('lisaIncome').textContent = formatCurrency(metrics.lisaIncome);

            // Update investment contributions
            const totalContributions = metrics.businessInvestmentContributions + metrics.directContributions;
            document.getElementById('totalInvestmentContributions').textContent = formatCurrency(totalContributions);
            document.getElementById('businessContributions').textContent = formatCurrency(metrics.businessInvestmentContributions);
            document.getElementById('directContributions').textContent = formatCurrency(metrics.directContributions);

            // Update goal progress
            const combinedNet = metrics.realEstateNet + metrics.businessNet;
            const goalAmount = 17932;
            const goalProgress = Math.min((combinedNet / goalAmount) * 100, 100);
            
            document.getElementById('combinedNet').textContent = formatCurrency(combinedNet);
            document.getElementById('goalProgress').style.width = `${goalProgress}%`;
            document.getElementById('goalPercentage').textContent = `${goalProgress.toFixed(1)}%`;

            updateRecentTransactions();
        }

        function getCurrentInvestmentValue() {
            const latestInvestment = investmentData
                .filter(inv => inv.type === 'value')
                .sort((a, b) => b.date.seconds - a.date.seconds)[0];
            
            return latestInvestment ? latestInvestment.amount : 0;
        }

        function updateInvestmentTab() {
            const currentValue = getCurrentInvestmentValue();
            const lastUpdate = investmentData
                .filter(inv => inv.type === 'value')
                .sort((a, b) => b.date.seconds - a.date.seconds)[0];

            document.getElementById('currentInvestmentValue').textContent = formatCurrency(currentValue);
            document.getElementById('lastUpdateDate').textContent = lastUpdate ? 
                new Date(lastUpdate.date.seconds * 1000).toLocaleDateString() : 'Never';

            // Calculate monthly and YTD contributions
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthlyContributions = investmentData
                .filter(inv => {
                    const invDate = new Date(inv.date.seconds * 1000);
                    return inv.type === 'contribution' && 
                           invDate.getMonth() === currentMonth && 
                           invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + inv.amount, 0);

            const ytdContributions = investmentData
                .filter(inv => {
                    const invDate = new Date(inv.date.seconds * 1000);
                    return inv.type === 'contribution' && invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + inv.amount, 0);

            document.getElementById('monthlyContributions').textContent = formatCurrency(monthlyContributions);
            document.getElementById('ytdContributions').textContent = formatCurrency(ytdContributions);

            // Update investment history table
            updateInvestmentHistoryTable();
        }

        function updateInvestmentHistoryTable() {
            const table = document.getElementById('investmentHistoryTable');
            table.innerHTML = '';

            const sortedInvestments = [...investmentData]
                .sort((a, b) => b.date.seconds - a.date.seconds)
                .slice(0, 20);

            sortedInvestments.forEach(inv => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(inv.date.seconds * 1000).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${inv.type === 'value' ? 'Account Value' : 'Contribution'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${inv.type === 'value' ? 'text-blue-600' : 'text-green-600'}">
                        ${formatCurrency(inv.amount)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${inv.source || 'Manual'}
                    </td>
                `;
                table.appendChild(row);
            });
        }

        // PDF Processing Functions
        async function processSchwabPDF(file) {
            try {
                showPDFProcessingStatus(true);
                updatePDFProgress(10);

                const arrayBuffer = await file.arrayBuffer();
                updatePDFProgress(30);

                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                updatePDFProgress(50);

                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                }
                updatePDFProgress(80);

                // Extract ending balance and deposits
                const extractedData = extractSchwabData(fullText);
                updatePDFProgress(100);

                if (extractedData.endingBalance || extractedData.deposits) {
                    // Save the extracted data
                    const currentDate = new Date();
                    
                    if (extractedData.endingBalance) {
                        investmentData.push({
                            id: generateId(),
                            type: 'value',
                            amount: extractedData.endingBalance,
                            date: { seconds: currentDate.getTime() / 1000 },
                            source: 'Schwab PDF',
                            userId: currentUser.uid
                        });
                    }

                    if (extractedData.deposits > 0) {
                        investmentData.push({
                            id: generateId(),
                            type: 'contribution',
                            amount: extractedData.deposits,
                            date: { seconds: currentDate.getTime() / 1000 },
                            source: 'Schwab PDF',
                            userId: currentUser.uid
                        });
                    }

                    saveData();
                    updateInvestmentTab();
                    updateDashboard();
                    
                    alert(`Successfully extracted:\nEnding Balance: ${formatCurrency(extractedData.endingBalance || 0)}\nMonthly Deposits: ${formatCurrency(extractedData.deposits || 0)}`);
                } else {
                    alert('Could not extract investment data from PDF. Please check the file format.');
                }

                showPDFProcessingStatus(false);
            } catch (error) {
                console.error('Error processing PDF:', error);
                alert('Error processing PDF: ' + error.message);
                showPDFProcessingStatus(false);
            }
        }

        function extractSchwabData(text) {
            const data = { endingBalance: 0, deposits: 0 };
            
            // Common patterns for Schwab statements
            const balancePatterns = [
                /ending\s+balance[:\s]+\$?([\d,]+\.?\d*)/i,
                /account\s+value[:\s]+\$?([\d,]+\.?\d*)/i,
                /total\s+value[:\s]+\$?([\d,]+\.?\d*)/i,
                /balance[:\s]+\$?([\d,]+\.?\d*)/i
            ];

            const depositPatterns = [
                /deposits?[:\s]+\$?([\d,]+\.?\d*)/i,
                /contributions?[:\s]+\$?([\d,]+\.?\d*)/i,
                /transfers?\s+in[:\s]+\$?([\d,]+\.?\d*)/i
            ];

            // Try to find ending balance
            for (const pattern of balancePatterns) {
                const match = text.match(pattern);
                if (match) {
                    data.endingBalance = parseFloat(match[1].replace(/,/g, ''));
                    break;
                }
            }

            // Try to find deposits
            for (const pattern of depositPatterns) {
                const match = text.match(pattern);
                if (match) {
                    data.deposits = parseFloat(match[1].replace(/,/g, ''));
                    break;
                }
            }

            return data;
        }

        function showPDFProcessingStatus(show) {
            const status = document.getElementById('pdfProcessingStatus');
            if (show) {
                status.classList.remove('hidden');
                updatePDFProgress(0);
            } else {
                status.classList.add('hidden');
                document.getElementById('pdfFileInput').value = '';
            }
        }

        function updatePDFProgress(percent) {
            document.getElementById('pdfProgress').style.width = `${percent}%`;
        }

        // Update UI
        function updateUI() {
            updateAccountsList();
            updateTransactionsList();
            updateAccountDropdowns();
            updateDashboard();
            updateInvestmentTab();
        }

        function updateAccountsList() {
            const accountsList = document.getElementById('accountsList');
            accountsList.innerHTML = '';

            if (accounts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                        No accounts found. Use "Quick Setup" or "Add Account" to get started.
                    </td>
                `;
                accountsList.appendChild(row);
                return;
            }

            accounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${account.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${account.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(account.balance)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="deleteAccount('${account.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                accountsList.appendChild(row);
            });
        }

        function updateTransactionsList() {
            const transactionsList = document.getElementById('transactionsList');
            const filterAccount = document.getElementById('filterAccount').value;
            const filterType = document.getElementById('filterType').value;
            const filterCategory = document.getElementById('filterCategory').value;

            let filteredTransactions = transactions;
            if (filterAccount) {
                filteredTransactions = filteredTransactions.filter(t => t.accountId === filterAccount);
            }
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            if (filterCategory) {
                filteredTransactions = filteredTransactions.filter(t => t.category === filterCategory);
            }

            transactionsList.innerHTML = '';

            const displayCount = Math.min(filteredTransactions.length, 100);
            filteredTransactions.slice(0, displayCount).forEach(transaction => {
                const account = accounts.find(a => a.id === transaction.accountId);
                const accountName = account ? account.name : 'Unknown Account';
                
                const div = document.createElement('div');
                div.className = 'px-6 py-4 flex justify-between items-center hover:bg-gray-50';
                
                let typeColor = 'text-gray-600';
                if (transaction.category === "Lisa's Income") {
                    typeColor = 'text-pink-600';
                } else if (transaction.category === 'Investment Contribution') {
                    typeColor = 'text-blue-600';
                } else if (transaction.type === 'Income') {
                    typeColor = 'text-green-600';
                } else if (transaction.type === 'Expense') {
                    typeColor = 'text-red-600';
                }
                
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-900">${transaction.description}</div>
                        <div class="text-sm text-gray-500">${accountName} • ${transaction.category}</div>
                        <div class="text-xs text-gray-400">${new Date(transaction.date.seconds * 1000).toLocaleDateString()}</div>
                    </div>
                    <div class="text-sm font-medium ${typeColor}">
                        ${transaction.type === 'Expense' ? '-' : ''}${formatCurrency(Math.abs(transaction.amount))}
                    </div>
                `;
                transactionsList.appendChild(div);
            });

            if (filteredTransactions.length > displayCount) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'px-6 py-4 text-center text-gray-500 text-sm';
                moreDiv.textContent = `Showing ${displayCount} of ${filteredTransactions.length} transactions`;
                transactionsList.appendChild(moreDiv);
            }
        }

        function updateAccountDropdowns() {
            const selects = [
                document.getElementById('transactionAccount'),
                document.getElementById('transferAccount'),
                document.getElementById('filterAccount'),
                document.getElementById('analyticsAccount')
            ];

            selects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                const isFilterSelect = select.id === 'filterAccount' || select.id === 'analyticsAccount';
                
                select.innerHTML = isFilterSelect ? 
                    '<option value="">All Accounts</option>' : 
                    '<option value="">Select Account</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });

            const categorySelect = document.getElementById('filterCategory');
            if (categorySelect) {
                const currentCategory = categorySelect.value;
                const categories = [...new Set(transactions.map(t => t.category))].sort();
                
                categorySelect.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                categorySelect.value = currentCategory;
            }
        }

        function updateRecentTransactions() {
            const recentTransactions = document.getElementById('recentTransactions');
            recentTransactions.innerHTML = '';

            transactions.slice(0, 5).forEach(transaction => {
                const account = accounts.find(a => a.id === transaction.accountId);
                const accountName = account ? account.name : 'Unknown Account';
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0';
                
                let typeColor = 'text-gray-600';
                if (transaction.category === "Lisa's Income") {
                    typeColor = 'text-pink-600';
                } else if (transaction.category === 'Investment Contribution') {
                    typeColor = 'text-blue-600';
                } else if (transaction.type === 'Income') {
                    typeColor = 'text-green-600';
                } else if (transaction.type === 'Expense') {
                    typeColor = 'text-red-600';
                }
                
                div.innerHTML = `
                    <div>
                        <div class="text-sm font-medium text-gray-900">${transaction.description}</div>
                        <div class="text-xs text-gray-500">${accountName} • ${transaction.category} • ${new Date(transaction.date.seconds * 1000).toLocaleDateString()}</div>
                    </div>
                    <div class="text-sm font-medium ${typeColor}">
                        ${transaction.type === 'Expense' ? '-' : ''}${formatCurrency(Math.abs(transaction.amount))}
                    </div>
                `;
                recentTransactions.appendChild(div);
            });
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        async function setupPredefinedAccounts() {
            const predefinedAccounts = [
                { name: 'Sweep Account (0111)', type: 'Checking', balance: 0 },
                { name: 'Real Estate Ops (8529)', type: 'Business', balance: 0 },
                { name: 'Tech Auditing (7991)', type: 'Business', balance: 0 },
                { name: 'Business Expenses (2299)', type: 'Credit Card', balance: 0 },
                { name: 'Visa Prime (2434)', type: 'Credit Card', balance: 0 },
                { name: 'Shared Checking (7588)', type: 'Checking', balance: 0 },
                { name: 'Investment (8895)', type: 'Investment', balance: 0 },
                { name: "Lisa's Income (0898)", type: 'Checking', balance: 0 }
            ];

            if (confirm('This will create your predefined accounts. Continue?')) {
                try {
                    const existingNames = accounts.map(a => a.name);
                    const newAccounts = predefinedAccounts.filter(account => 
                        !existingNames.includes(account.name)
                    );

                    newAccounts.forEach(account => {
                        accounts.push({
                            ...account,
                            id: generateId(),
                            userId: currentUser.uid
                        });
                    });
                    
                    saveData();
                    alert(`Created ${newAccounts.length} new accounts!`);
                    await loadData();
                } catch (error) {
                    console.error('Error setting up accounts:', error);
                    alert('Error creating accounts: ' + error.message);
                }
            }
        }

        async function deleteAccount(accountId) {
            if (confirm('Are you sure you want to delete this account? This will also delete all associated transactions.')) {
                try {
                    accounts = accounts.filter(a => a.id !== accountId);
                    transactions = transactions.filter(t => t.accountId !== accountId);
                    saveData();
                    loadData();
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Error deleting account: ' + error.message);
                }
            }
        }

        function exportData() {
            const data = {
                accounts: accounts,
                transactions: transactions.map(t => ({
                    ...t,
                    date: new Date(t.date.seconds * 1000).toISOString()
                })),
                investmentData: investmentData.map(inv => ({
                    ...inv,
                    date: new Date(inv.date.seconds * 1000).toISOString()
                })),
                baselineNetWorth: baselineNetWorth,
                exportDate: new Date().toISOString(),
                totalNetWorth: baselineNetWorth + accounts.reduce((sum, acc) => sum + acc.balance, 0) + getCurrentInvestmentValue(),
                totalTransactions: transactions.length
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update active nav button
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('text-white', 'border-blue-600');
                    b.classList.add('text-blue-200');
                });
                btn.classList.remove('text-blue-200');
                btn.classList.add('text-white', 'border-b-2', 'border-blue-600');
                
                // Show active tab
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tab).classList.remove('hidden');
                
                if (tab === 'dashboard') {
                    updateDashboard();
                } else if (tab === 'investments') {
                    updateInvestmentTab();
                }
            });
        });

        // Modal handling
        document.getElementById('setBaselineBtn').addEventListener('click', () => {
            document.getElementById('baselineAmount').value = baselineNetWorth || '';
            document.getElementById('baselineModal').classList.remove('hidden');
        });

        document.getElementById('cancelBaseline').addEventListener('click', () => {
            document.getElementById('baselineModal').classList.add('hidden');
            document.getElementById('baselineForm').reset();
        });

        document.getElementById('baselineForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('baselineAmount').value);
            if (!isNaN(amount)) {
                baselineNetWorth = amount;
                saveData();
                updateDashboard();
                document.getElementById('baselineModal').classList.add('hidden');
                document.getElementById('baselineForm').reset();
                alert('Baseline net worth updated successfully!');
            }
        });

        document.getElementById('addAccountBtn').addEventListener('click', () => {
            document.getElementById('accountModal').classList.remove('hidden');
        });

        document.getElementById('addTransactionBtn').addEventListener('click', () => {
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionModal').classList.remove('hidden');
        });

        document.getElementById('cancelAccount').addEventListener('click', () => {
            document.getElementById('accountModal').classList.add('hidden');
            document.getElementById('accountForm').reset();
        });

        document.getElementById('cancelTransaction').addEventListener('click', () => {
            document.getElementById('transactionModal').classList.add('hidden');
            document.getElementById('transactionForm').reset();
            document.getElementById('transferAccountDiv').classList.add('hidden');
        });

        // Transaction type change handler
        document.getElementById('transactionType').addEventListener('change', (e) => {
            const transferDiv = document.getElementById('transferAccountDiv');
            const categorySelect = document.getElementById('transactionCategory');
            
            if (e.target.value === 'Transfer') {
                transferDiv.classList.remove('hidden');
                categorySelect.value = 'Transfer';
                categorySelect.disabled = true;
            } else {
                transferDiv.classList.add('hidden');
                categorySelect.disabled = false;
                categorySelect.value = '';
            }
        });

        // PDF upload handling
        document.getElementById('uploadSchwabBtn').addEventListener('click', () => {
            document.getElementById('pdfFileInput').click();
        });

        document.getElementById('pdfUploadBtn').addEventListener('click', () => {
            document.getElementById('pdfFileInput').click();
        });

        document.getElementById('pdfFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                processSchwabPDF(file);
            } else {
                alert('Please select a valid PDF file.');
            }
        });

        // Form submissions
        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const accountData = {
                id: generateId(),
                name: document.getElementById('accountName').value,
                type: document.getElementById('accountType').value,
                balance: parseFloat(document.getElementById('startingBalance').value),
                userId: currentUser.uid
            };

            try {
                accounts.push(accountData);
                saveData();
                
                document.getElementById('accountModal').classList.add('hidden');
                document.getElementById('accountForm').reset();
                loadData();
            } catch (error) {
                console.error('Error adding account:', error);
            }
        });

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const accountId = document.getElementById('transactionAccount').value;
            const transferAccountId = document.getElementById('transferAccount').value;
            const description = document.getElementById('transactionDescription').value;
            
            // Get account names for enhanced categorization
            const fromAccount = accounts.find(a => a.id === accountId);
            const toAccount = accounts.find(a => a.id === transferAccountId);
            
            let category = document.getElementById('transactionCategory').value;
            
            // Enhanced categorization for transfers
            if (type === 'Transfer' && fromAccount && toAccount) {
                category = enhancedCategorizeTransaction(description, fromAccount.name, toAccount.name, amount);
            }
            
            const baseTransaction = {
                id: generateId(),
                description: description,
                amount: type === 'Expense' ? -Math.abs(amount) : Math.abs(amount),
                type: type,
                date: { seconds: new Date(document.getElementById('transactionDate').value).getTime() / 1000 },
                accountId: accountId,
                category: category,
                userId: currentUser.uid
            };

            try {
                if (type === 'Transfer' && transferAccountId) {
                    // Create two transactions for transfers
                    const outTransaction = {
                        ...baseTransaction,
                        id: generateId(),
                        amount: -Math.abs(amount),
                        description: `Transfer to ${toAccount?.name || 'Unknown'}`
                    };
                    
                    const inTransaction = {
                        ...baseTransaction,
                        id: generateId(),
                        accountId: transferAccountId,
                        amount: Math.abs(amount),
                        description: `Transfer from ${fromAccount?.name || 'Unknown'}`
                    };

                    transactions.unshift(outTransaction, inTransaction);
                    
                    // Update account balances
                    if (fromAccount && toAccount) {
                        fromAccount.balance -= Math.abs(amount);
                        toAccount.balance += Math.abs(amount);
                    }
                } else {
                    // Regular transaction
                    transactions.unshift(baseTransaction);
                    
                    // Update account balance
                    const account = accounts.find(a => a.id === accountId);
                    if (account) {
                        account.balance += baseTransaction.amount;
                    }
                }

                saveData();
                document.getElementById('transactionModal').classList.add('hidden');
                document.getElementById('transactionForm').reset();
                document.getElementById('transferAccountDiv').classList.add('hidden');
                loadData();
            } catch (error) {
                console.error('Error adding transaction:', error);
            }
        });

        // Filter handlers
        document.getElementById('filterAccount').addEventListener('change', updateTransactionsList);
        document.getElementById('filterType').addEventListener('change', updateTransactionsList);
        document.getElementById('filterCategory').addEventListener('change', updateTransactionsList);

        // Authentication handlers
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showAuthError(error.message);
            }
        });

        document.getElementById('registerBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                showAuthError(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // CSV Import (existing functionality preserved)
        function setupCSVImport() {
            const csvDropZone = document.getElementById('csvDropZone');
            const csvFileInput = document.getElementById('csvFileInput');
            const csvUploadBtn = document.getElementById('csvUploadBtn');

            if (csvUploadBtn) {
                csvUploadBtn.addEventListener('click', () => {
                    csvFileInput.click();
                });
            }

            if (csvFileInput) {
                csvFileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        processCSVFiles(files);
                    }
                });
            }

            if (document.getElementById('clearImportBtn')) {
                document.getElementById('clearImportBtn').addEventListener('click', clearImport);
            }
            if (document.getElementById('validateImportBtn')) {
                document.getElementById('validateImportBtn').addEventListener('click', validateImport);
            }
            if (document.getElementById('processImportBtn')) {
                document.getElementById('processImportBtn').addEventListener('click', processImport);
            }
        }

        function processCSVFiles(files) {
            // Existing CSV processing logic preserved
            console.log('Processing CSV files:', files.length);
        }

        function clearImport() {
            importedTransactions = [];
            const importProgress = document.getElementById('importProgress');
            const importPreview = document.getElementById('importPreview');
            if (importProgress) importProgress.classList.add('hidden');
            if (importPreview) importPreview.classList.add('hidden');
        }

        function validateImport() {
            console.log('Validating import...');
        }

        function processImport() {
            console.log('Processing import...');
        }

        // Analytics (preserved from existing)
        function updateAnalytics() {
            console.log('Updating analytics...');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dashboard').classList.remove('hidden');
            
            setupCSVImport();
            
            document.getElementById('refreshDataBtn').addEventListener('click', loadData);
            document.getElementById('quickSetupBtn').addEventListener('click', setupPredefinedAccounts);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('refreshInvestmentsBtn').addEventListener('click', updateInvestmentTab);
            
            const refreshAnalyticsBtn = document.getElementById('refreshAnalyticsBtn');
            if (refreshAnalyticsBtn) {
                refreshAnalyticsBtn.addEventListener('click', updateAnalytics);
            }
        });

        // Make functions available globally
        window.deleteAccount = deleteAccount;
    </script>
</body>
</html>
                            